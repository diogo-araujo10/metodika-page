<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Mental - Indicadores Agropecu√°rios</title>

  <!-- jsMind CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmind/style/jsmind.css" />
  
  <!-- html2canvas para captura mais confi√°vel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* Anima√ß√£o apenas para a caixinha modal */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    html, body {
      height: 100%;
      margin: 0;
      background: #f7f9fc;
      font-family: sans-serif;
    }

    #jsmind_container {
      width: 100%;
      height: 100vh;
      display: none; /* come√ßa escondido at√© gerar o mapa */
      background: white !important; /* fundo branco para o download */
      position: relative;
    }

    /* Container principal para captura */
    #capture-container {
      position: relative;
      width: 100%;
      height: 100%;
      background: white;
    }

    /* Footer para a refer√™ncia */
    .jmind-footer {
      position: absolute;
      bottom: 20px;
      left: 0;
      width: 100%;
      text-align: center;
      font-size: 14px;
      color: #333;
      padding: 10px;
      background: white;
      border-top: 1px solid #ddd;
      z-index: 100;
      font-family: sans-serif;
      display: none; /* s√≥ aparece no download */
    }

    /* Tela inicial */
    #start-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
      background: #eef3fa;
      position: relative;
    }
    #start-screen h1 {
      margin-bottom: 20px;
      color: #333;
    }
    #titulo-input {
      padding: 12px 18px;
      font-size: 18px;
      border: 2px solid #0074d9;
      border-radius: 8px;
      outline: none;
      margin-bottom: 15px;
      width: 320px;
      max-width: 90%;
    }
    #gerar-btn {
      padding: 12px 25px;
      font-size: 16px;
      background: #0074d9;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }
    #gerar-btn:hover {
      background: #005fa3;
    }

    /* Modal - Estilo igual √† p√°gina de Identifica√ß√£o do Problema */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 30px;
      border: 1px solid #888;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: fadeIn 0.4s ease-out; /* Apenas a caixinha tem anima√ß√£o */
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
    }

    .instrucoes ul {
      padding-left: 20px;
    }

    .instrucoes li {
      margin-bottom: 12px;
      font-size: 16px;
      line-height: 1.4;
    }

    .dica {
      margin-top: 15px;
      font-style: italic;
      color: #666;
    }

    /* estilo dos n√≥s */
    .jmnode {
      font-size: 15px;
      padding: 10px 18px;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      color: #222;
      max-width: 400px;
      border: 1px solid #e0e0e0;
    }

    /* n√≥ raiz */
    .jmnode[nodeid="root"] {
      font-size: 22px;
      font-weight: bold;
      padding: 25px 40px;
      border: 3px solid #0074d9;
      background: #e6f0ff;
      border-radius: 14px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      text-align: center;
      max-width: 500px;
    }

    /* Linhas do mapa mental com cor mais escura */
    jmnode > jmnodes > jmnode > jmexpander,
    jmnode > jmnodes > jmnode {
      border-color: #666 !important;
    }
  </style>
</head>
<body>
  <!-- Modal de Instru√ß√µes - Igual √† p√°gina de Identifica√ß√£o do Problema -->
  <div id="modalInstrucoes" class="modal">
    <div class="modal-content">
      <span class="close" onclick="fecharModal()">&times;</span>
      <h3>üí° IMPORTANTE</h3>
      <div class="instrucoes">
        <ul>
          <li>Antes de baixar a imagem, ajuste o zoom da p√°gina (Ctrl + Scroll) para enquadrar todo o mapa mental na tela;</li>
          <li>Isso garante que a imagem ficar√° bem organizada e completa, mostrando toda a estrutura do fluxo metodol√≥gico.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Tela inicial -->
  <div id="start-screen">
    <h1>Digite o T√≠tulo do Fluxo Metodol√≥gico</h1>
    <input id="titulo-input" type="text" placeholder="Ex: An√°lise Bibliom√©trica na Ergonomia" />
    <button id="gerar-btn">Gerar Fluxo Metodol√≥gico</button>
  </div>

  <!-- Container do mapa -->
  <div id="jsmind_container">
    <div id="capture-container">
      <div class="jmind-footer" id="jmind_footer">
        PEREIRA, Daniel Augusto de Moura; ARA√öJO, Diogo Sebasti√£o Pereira; SANTOS, Jamily Ferreira dos; DINIZ, Bruno Pereira. METODIKA (v1) 2025. 2025
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsmind/js/jsmind.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsmind/js/jsmind.screenshot.js"></script>
  <script>
    // üîπ Carrega os dados salvos
    const problema  = localStorage.getItem("problema")  || "Falta de M√©tricas Mais Detalhadas dos Indicadores";
    const baseDados = localStorage.getItem("baseDados") || "Secund√°ria";
    const metodosColetaStr = localStorage.getItem("metodosColeta") || "";
    const softwares = JSON.parse(localStorage.getItem("softwares")) || ["Microsoft Excel"];
    const resultado = localStorage.getItem("obtido")    || "Cria√ß√£o de um Dashboard dos Indicadores Agropecu√°rios dos anos de 2011 √† 2022";

    // transforma string em array (se houver m√∫ltiplos m√©todos)
    const metodosColeta = metodosColetaStr.split(",").map(m => m.trim()).filter(m => m);

    let jm; // vari√°vel global para o mapa mental

    // Mostrar modal ao carregar a p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('modalInstrucoes').style.display = 'flex';
    });

    // Fun√ß√£o para fechar o modal
    function fecharModal() {
      document.getElementById('modalInstrucoes').style.display = 'none';
    }

    // Fechar modal clicando fora
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('modalInstrucoes');
      if (event.target === modal) {
        fecharModal();
      }
    });

    document.getElementById("gerar-btn").addEventListener("click", () => {
        let tituloRaiz = document.getElementById("titulo-input").value.trim();
        if (!tituloRaiz) {
            tituloRaiz = "Indicadores Agropecu√°rios";
        }

        // Esconde tela inicial e mostra o mapa (sem anima√ß√£o)
        document.getElementById("start-screen").style.display = "none";
        document.getElementById("jsmind_container").style.display = "block";

        const mind = {
            "meta": { "name": "indicadores", "author": "Projeto", "version": "2.0" },
            "format": "node_tree",
            "data": {
                "id": "root",
                "topic": tituloRaiz,
                "children": [
                    { 
                        "id": "problema", 
                        "topic": "üìâ Problema Identificado",
                        "children": [ {"id": "problema_txt", "topic": problema} ]
                    },
                    { 
                        "id": "coleta", 
                        "topic": "üìä Coleta de Dados",
                        "children": [
                            { 
                                "id": "base_dados", 
                                "topic": baseDados,
                                "children": metodosColeta.map((m, i) => ({
                                    "id": `metodo_${i+1}`,
                                    "topic": m
                                }))
                            }
                        ]
                    },
                    { 
                        "id": "analise", 
                        "topic": "‚è≥ An√°lise de Dados",
                        "children": softwares.map((s, i) => ({
                            "id": `analise_soft${i+1}`,
                            "topic": s
                        }))
                    },
                    { 
                        "id": "resultado", 
                        "topic": "‚úÖ Resultado",
                        "children": [ {"id": "resultado_txt", "topic": resultado} ]
                    }
                ]
            }
        };

        const options = {
            container: 'capture-container',
            theme: 'primary',
            editable: false,
            layout: {
                hspace: 140,
                vspace: 80
            }
        };

        jm = new jsMind(options);
        jm.show(mind);

        // üîπ Adiciona bot√£o de download ap√≥s gerar o mapa
        adicionarBotaoDownload();
    });

    // üîπ Fun√ß√£o para adicionar bot√£o de download
    function adicionarBotaoDownload() {
        // Remove bot√£o anterior se existir
        const botaoAnterior = document.getElementById('download-btn');
        if (botaoAnterior) {
            botaoAnterior.remove();
        }

        // Cria o bot√£o de download
        const downloadBtn = document.createElement('button');
        downloadBtn.id = 'download-btn';
        downloadBtn.innerHTML = 'üì• DOWNLOAD DA IMAGEM';
        downloadBtn.style.position = 'fixed';
        downloadBtn.style.top = '20px';
        downloadBtn.style.right = '20px';
        downloadBtn.style.zIndex = '1000';
        downloadBtn.style.padding = '12px 20px';
        downloadBtn.style.background = '#28a745';
        downloadBtn.style.color = 'white';
        downloadBtn.style.border = 'none';
        downloadBtn.style.borderRadius = '8px';
        downloadBtn.style.cursor = 'pointer';
        downloadBtn.style.fontSize = '16px';
        downloadBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
        downloadBtn.style.transition = 'all 0.3s';

        downloadBtn.onmouseover = function() {
            this.style.background = '#218838';
            this.style.transform = 'translateY(-2px)';
        };
        downloadBtn.onmouseout = function() {
            this.style.background = '#28a745';
            this.style.transform = 'translateY(0)';
        };

        // Adiciona evento de clique
        downloadBtn.addEventListener('click', baixarComoImagem);

        document.body.appendChild(downloadBtn);
    }

    // üîπ Fun√ß√£o para baixar como imagem usando html2canvas
    function baixarComoImagem() {
        if (!jm) {
            alert('Erro: Mapa mental n√£o foi carregado corretamente.');
            return;
        }

        try {
            // Mostra loading
            const downloadBtn = document.getElementById('download-btn');
            downloadBtn.innerHTML = '‚è≥ Gerando Imagem...';
            downloadBtn.disabled = true;

            // Mostra o footer com a refer√™ncia
            const footer = document.getElementById('jmind_footer');
            footer.style.display = 'block';

            // Pequeno delay para garantir que o footer foi renderizado
            setTimeout(() => {
                // Usa html2canvas para capturar todo o container
                html2canvas(document.getElementById('capture-container'), {
                    backgroundColor: '#ffffff',
                    scale: 2, // Melhor qualidade
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    // Converte o canvas para imagem e faz download
                    const link = document.createElement('a');
                    link.download = 'mapa-mental-' + new Date().getTime() + '.png';
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();

                    // Esconde o footer ap√≥s o download
                    footer.style.display = 'none';
                    
                    // Restaura o bot√£o ap√≥s o download
                    downloadBtn.innerHTML = 'üì• DOWNLOAD DA IMAGEM';
                    downloadBtn.disabled = false;
                }).catch(error => {
                    console.error('Erro ao capturar imagem:', error);
                    alert('Erro ao gerar a imagem. Tente novamente.');
                    
                    // Esconde o footer em caso de erro
                    footer.style.display = 'none';
                    downloadBtn.innerHTML = 'üì• DOWNLOAD DA IMAGEM';
                    downloadBtn.disabled = false;
                });
            }, 500);

        } catch (error) {
            console.error('Erro ao gerar imagem:', error);
            alert('Erro ao gerar a imagem. Tente novamente.');
            
            // Esconde o footer em caso de erro
            document.getElementById('jmind_footer').style.display = 'none';
            
            const downloadBtn = document.getElementById('download-btn');
            downloadBtn.innerHTML = 'üì• DOWNLOAD DA IMAGEM';
            downloadBtn.disabled = false;
        }
    }
  </script>
</body>
</html>